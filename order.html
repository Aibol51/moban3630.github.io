<!DOCTYPE html>
<html lang="zxx">
  <head>
    <title>人工碎石料</title>
    <!-- Meta tag Keywords -->
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8" />
    <meta name="keywords" content="" />
    <script>
      addEventListener(
        "load",
        function () {
          setTimeout(hideURLbar, 0);
        },
        false
      );

      function hideURLbar() {
        window.scrollTo(0, 1);
      }
    </script>
    <!-- //Meta tag Keywords -->

    <!-- Custom-Files -->
    <link rel="stylesheet" href="css/bootstrap.css" />
    <!-- Bootstrap-Core-CSS -->
    <link rel="stylesheet" href="css/style.css" type="text/css" media="all" />
    <!-- Style-CSS -->
    <link href="css/font-awesome.min.css" rel="stylesheet" />
    <!-- Font-Awesome-Icons-CSS -->
    <!-- //Custom-Files -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Web-Fonts -->
    <link
      href="http://fonts.googleapis.com/css?family=Poppins:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i"
      rel="stylesheet"
    />
    <link
      href="http://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i"
      rel="stylesheet"
    />
    <!-- //Web-Fonts -->
  </head>

  <body>
    <!-- header -->
    <header id="home">
      <div class="container">
        <div
          class="header d-lg-flex justify-content-between align-items-center py-sm-3 py-2 px-sm-2 px-1"
        >
          <!-- logo -->
          <div id="logo">
            <h1><a href="index.html">Stroy Kad</a></h1>
          </div>
          <!-- //logo -->
          <!-- nav -->
          <div class="nav_w3ls ml-lg-5">
            <nav>
              <label for="drop" class="toggle">菜单</label>
              <input type="checkbox" id="drop" />
              <ul class="menu">
                <li><a href="index.html">首页</a></li>
                <li><a href="about.html">关于我们</a></li>
                <li><a href="portfolio.html">案例展示</a></li>
                <li><a href="order.html">人工碎石料</a></li>
                <li><a href="contact.html">·联系方式</a></li>
                <li
                  id="user-links"
                  class="ml-xl-5 ml-lg-2 mt-lg-0 mt-sm-4 mt-3"
                >
                  <a
                    href="login.html"
                    id="login-link"
                    class="reqe-button text-uppercase"
                    >登录</a
                  >
                  <a
                    href="register.html"
                    id="register-link"
                    class="reqe-button text-uppercase"
                    >注册</a
                  >
                </li>
              </ul>
            </nav>
          </div>
          <!-- //nav -->
        </div>
      </div>
    </header>
    <!-- //header -->
    <!-- inner banner -->
    <div
      class="inner-banner-w3ls d-flex flex-column justify-content-center align-items-center"
    ></div>
    <!-- //inner banner -->
    <!-- breadcrumbs -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb d-flex justify-content-center">
        <li class="breadcrumb-item">
          <a href="index.html">首页</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">人工碎石料</li>
      </ol>
    </nav>
    <!-- //breadcrumbs -->
    <!-- portfolio -->
    <section
      class="portfolio-wthree align-w3 py-5 position-relative"
      id="portfolio"
    >
      <div class="container py-xl-5 py-lg-3">
        <div class="wthree_pvt_title text-center">
          <h4 class="w3pvt-title">人工碎石料</h4>
          <!-- <p class="sub-title">
            Subheadings stand out because they are like mini titles. They make
            your post stand out and make it more readable.
          </p> -->
        </div>
        <div>
          <ul class="demo row"></ul>
        </div>
      </div>
    </section>
    <!-- //portfolio -->

    <!-- calculator -->
    <div class="calBox">
      <h1 id="calH1">砂石运输费用计算器</h1>
      <p>请输入砂石重量（吨）和运输距离（公里）：</p>
      <input
        type="number"
        class="calInput"
        id="weight"
        placeholder="砂石重量（吨）"
        min="0"
        step="1"
      />
      <input
        type="number"
        class="calInput"
        id="distance"
        placeholder="运输距离（公里）"
        min="0"
        step="1"
      />
      <button class="calInput" id="calBtn" onclick="calculate()">
        计算运输费用
      </button>
      <div id="result"></div>
    </div>
    <!-- footer -->
    <footer class="footer py-md-5 pt-md-3 pb-sm-5">
      <div class="container">
        <div class="row p-sm-4 px-3 py-3">
          <div class="col-lg-4 footer-top mt-md-0 mt-sm-5 wrapStyle">
            <h2>
              <a class="navbar-brand" href="index.html"> 货运 </a>
            </h2>
            <div class="fv3-contact mt-2">
              <p>
                <a href="StroyKad001@gmail.com" style="text-decoration: none"
                  >StroyKad001@gmail.com</a
                >
              </p>
            </div>
            <div class="fv3-contact my-2">
              <p>+7 777 888 8888</p>
            </div>
            <div class="fv3-contact">
              <p>Astana street</p>
            </div>
          </div>
          <div class="col-lg-2 col-md-6 mt-lg-0 mt-4">
            <div class="footerv2-w3ls">
              <h3 class="mb-3 w3f_title">导航</h3>
              <hr />
              <ul class="list-w3pvtits">
                <li class="my-2">
                  <a href="index.html"> 首页 </a>
                </li>
                <li class="my-2">
                  <a href="about.html"> 关于我们 </a>
                </li>
                <li class="my-2">
                  <a href="portfolio.html"> 案例展示 </a>
                </li>
                <li class="mb-2">
                  <a href="order.html"> 人工碎石料 </a>
                </li>
                <li class="my-2">
                  <a href="contact.html"> 联系方式 </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <!-- //footer bottom -->
    </footer>
    <!-- //footer -->
    <!-- move top icon -->
    <a href="#home" class="move-top text-center">
      <span class="fa fa-level-up" aria-hidden="true"></span>
    </a>
    <!-- //move top icon -->
    <script>
      const pricePerTonKm = 36;

      function calculate() {
        const weight = parseFloat(document.getElementById("weight").value);
        const distance = parseFloat(document.getElementById("distance").value);
        if (isNaN(weight) || isNaN(distance)) {
          alert("请输入有效的砂石重量和运输距离。");
          return;
        }
        const cost = weight * distance * pricePerTonKm;
        document.getElementById("result").innerHTML =
          "运输费用(价格起伏不超过40%)：" + cost.toFixed(2) + " ТГ";
      }

      function calculatePrice(element) {
        const tons = element.value;
        const pricePerTon = parseFloat(element.dataset.price);
        const price = tons * pricePerTon;
        const priceOutput =
          element.parentElement.querySelector(".price-output");
        priceOutput.textContent = price + " 元";
      }

      async function clickOrder(element) {
        const currentUser = JSON.parse(localStorage.getItem("users"));
        if (!currentUser) {
          alert("请先登录");
          window.location.href = "/login.html";
          return;
        }

        const productIndex = element.dataset.productIndex;
        const product = products[productIndex];
        const tons = parseFloat(
          document.getElementById(`tons-input-${productIndex}`).value
        );
        if (isNaN(tons) || tons <= 0) {
          alert("请输入有效的砂石吨数。");
          return;
        }
        const pricePerTon = parseFloat(product.price.match(/\d+/)[0]);
        const totalPrice = tons * pricePerTon;

        const SUPABASE_URL = "https://vnswcmkocaomjscnsdsl.supabase.co";
        const SUPABASE_ANON_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuc3djbWtvY2FvbWpzY25zZHNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODE1NDExNTMsImV4cCI6MTk5NzExNzE1M30.mWRgT9fQ-dULZH9X4f9UfYlLRTvw07eHI3u-Ch0fLjs";
        // 初始化Supabase客户端
        const _supabase = supabase.createClient(
          SUPABASE_URL,
          SUPABASE_ANON_KEY
        );
        const tokenBaseString = localStorage.getItem(
          "sb-vnswcmkocaomjscnsdsl-auth-token"
        );
        const tokenBase = JSON.parse(tokenBaseString);
        const userId = tokenBase.user.id;

        // 检查用户是否在 user_info 表中存在
        const { data: existingUserInfo, error: fetchError } = await _supabase
          .from("user_info")
          .select("*")
          .eq("user_id", userId);

        if (fetchError) {
          console.error(fetchError);
          alert("查询用户信息时出错，请重试。");
          return;
        }

        if (existingUserInfo.length === 0) {
          alert("请先完善您的个人信息。");
          // 将用户重定向到信息填写页面
          window.location.href = "/my_address.html";
          return;
        }

        await _supabase
          .from("orders")
          .insert({
            user_id: userId,
            product_title: product.title,
            product_price: pricePerTon,
            tons: tons,
            total_price: totalPrice,
            product_image: product.imgSrc,
          })
          .then(() => {
            console.log("订单已保存到Supabase。");
            alert("下单成功");
          })
          .catch((error) => {
            console.error(error);
            alert("保存订单时出错，请重试。");
          });
      }

      const products = [
        {
          class: "col-lg-4",
          imgSrc: "images/0-5.jpg",
          imgAlt: " ",
          title: "0-5mm碎石",
          price: "一吨3000tg",
        },
        {
          class: "col-lg-4",
          imgSrc: "images/5-10.png",
          imgAlt: " ",
          title: "5-10mm碎石",
          price: "一吨3000tg",
        },
        {
          class: "col-lg-4",
          imgSrc: "images/10-20.jpg",
          imgAlt: " ",
          title: "10-20mm碎石",
          price: "一吨2400tg",
        },
        {
          class: "col-lg-4",
          imgSrc: "images/20-40.jpg",
          imgAlt: " ",
          title: "20-40mm碎石",
          price: "一吨2000tg",
        },
        {
          class: "col-lg-4",
          imgSrc: "images/40-70.jpeg",
          imgAlt: " ",
          title: "40-70mm碎石",
          price: "一吨1800tg",
        },
        // 添加更多产品对象
      ];

      function createListItem(product, index) {
        const pricePerTon = parseFloat(product.price.match(/\d+/)[0]);
        return `
    <li class="${product.class}">
      <div class="img-grid">
        <div class="Portfolio-grid1">
          <a >
            <img src="${product.imgSrc}" alt="${product.imgAlt}" class="img-fluid">
          </a>
        </div>
        <div class="port-desc text-center">
          <h6 class="main-title-w3pvt text-center">
            ${product.title}
          </h6>
          <div class="input-container">
            <input type="number" id="tons-input-${index}" data-price="${pricePerTon}" placeholder="请输入吨数" oninput="calculatePrice(this)" min="1" step="1">
            <span class="price-output" id="price-output-${index}">${product.price}</span>
            <button onclick="clickOrder(this)" data-product-index="${index}">下单</button>
          </div>
        </div>
      </div>
    </li>
  `;
      }

      const listItems = products.map(createListItem).join("");
      document.querySelector(".demo").innerHTML = listItems;
    </script>
    <script src="/main.js"></script>
  </body>
</html>
